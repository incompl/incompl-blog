<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Uploading Large Files in Ruby on Rails</title>
    <link rel="icon" type="image/png" href="http://incompl.com/images/favicon.png"/>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/code.css">
  </head>

  <body>
    <div id="wrapper">
      <span class="author">
        May 06, 2010
      </span>
      <h1><a href="/">incompl</a></h1>
      <h2>Uploading Large Files in Ruby on Rails</h2>
      <div class="post">
        <div class="entrybody">
          <p>
File upload is a common feature for web sites, yet for some reason a lot of frameworks make it hard on you. <a href="http://en.wikipedia.org/wiki/JavaServer_Faces">JSF</a> doesn't even support it by default; it requires the installation of additional libraries.
</p><p>
In Ruby on Rails it worked pretty well out of the box, but with a catch. File uploads are stored in memory, so if you are letting users upload large files, the server will quickly run out of memory.
</p><p>
To solve this I discovered a new (as of 2.3) component of Rails called <a href="http://weblog.rubyonrails.org/2008/12/17/introducing-rails-metal">Metal</a>. Metal is a thin wrapper around <a href="http://rack.rubyforge.org/">Rack</a>, a minimal piece of middleware that handles HTTP requests for Rails. While Metal is a part of Rails, it lets you bypass Rails for the most part, and work at a lower level for those performance-critical bits. Happily, Metal lets you grab an uploaded file without making a copy of it in memory.
</p><p>
Here is an example of a Metal class that does file upload. To test this you'd just need to throw it in a <em>/app/metal</em> directory for your Rails project, then navigate to <em>http://example.com/uploadtest</em> to try it out.
</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Uploadtest</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">env</span><span class="o">[</span><span class="s2">&quot;PATH_INFO&quot;</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/^\/uploadtest$/</span>

      <span class="n">request</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

      <span class="c1"># Get temp file from request</span>
      <span class="c1"># Format: {:filename, :type, :name, :tempfile, :head}</span>
      <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">]</span> 

      <span class="c1"># Make sure we have the parameter</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">file</span><span class="o">.</span><span class="n">nil?</span>

        <span class="c1"># Create new file path</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;uploads&quot;</span><span class="p">,</span> <span class="s2">&quot;uploadtest&quot;</span><span class="p">)</span>
        <span class="no">FileUtils</span><span class="o">.</span><span class="n">mkpath</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file</span><span class="o">[</span><span class="ss">:filename</span><span class="o">]</span><span class="p">)</span>

        <span class="c1"># Copy the uploaded file</span>
        <span class="no">FileUtils</span><span class="o">.</span><span class="n">cp</span> <span class="n">file</span><span class="o">[</span><span class="ss">:tempfile</span><span class="o">].</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span>

        <span class="c1"># Response</span>
        <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="o">[</span><span class="s2">&quot;Upload Complete&quot;</span><span class="o">]]</span>

      <span class="k">else</span>
        <span class="c1"># Show an example submission form</span>
        <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span>
              <span class="o">[</span><span class="s1">&#39;&amp;lt;form method=&quot;post&quot;</span>
<span class="s1">                      action=&quot;/uploadtest&quot;</span>
<span class="s1">                      enctype=&quot;multipart/form-data&quot;&amp;gt;</span>
<span class="s1">                &amp;lt;input type=&quot;file&quot; name=&quot;file&quot;/&amp;gt;</span>
<span class="s1">                &amp;lt;input type=&quot;submit&quot; value=&quot;Upload&quot;/&amp;gt;</span>
<span class="s1">                &amp;lt;/form&amp;gt;&#39;</span><span class="o">]]</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="o">[</span><span class="mi">404</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="o">[</span><span class="s2">&quot;Not Found&quot;</span><span class="o">]]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>
I hope this helps someone who runs into the same situation I was in!
</p>
        </div>
      </div>
    </div>
  </body>
</html>